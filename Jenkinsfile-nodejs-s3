#!/usr/bin/env groovy

pipeline {
  agent { 
	  label 'kubernetes-master-1'
  }
	
  stages {

    stage('Build docker images') {
      steps {
	      sh "docker build -f /home/ranul/workspace/nodejs-s3/docker/dockerfile-nodejs-s3 -t ranuldeepanayake/private:nodejs-s3 /"
        //sh "docker push ranuldeepanayake/private:nodejs-s3" 
      }
    }

    stage('Deploy on Kubernetes') {
      steps {
        sh 'kubectl apply -f /home/ranul/workspace/nodejs-s3/kubernetes/nodejs-s3-deployment.yml'
        sh 'kubectl apply -f /home/ranul/workspace/nodejs-s3/kubernetes/nodejs-s3-service.yml'
      }
    }

    stage('Code security analysis'){
      environment {
        scannerHome = tool 'SonarQube-1'
      }
      steps {
        script {
          withSonarQubeEnv('SonarQube-1') {
            sh "${scannerHome}/bin/sonar-scanner \
                -Dsonar.projectKey=node-app \
                -Dsonar.host.url=http://192.168.56.126:9000 \
                -Dsonar.token=sqa_9ca3249747b23cc2fac39510d39064b6e830788a \
                -Dsonar.sources=. "
          }
        }
      }
    }
  }
}